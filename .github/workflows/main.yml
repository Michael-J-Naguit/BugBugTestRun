name: Run BugBug - QRA Stage Suite

on: workflow_dispatch

jobs:
  run-bugbug-tests:
    runs-on: ubuntu-latest
    name: Run BugBug Tests
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run QRA Stage Suite
        id: run-bugbug-tests
        uses: bugbug-io/bugbug-github-action@v1.2.1
        with:
          apiToken: ${{ secrets.BUGBUG_API_TOKEN }}
          suiteId: fd0de8e7-4e32-4c5a-b776-a011b545dbc9
          outputPath: test-results-${{ github.run_id }}.xml

      - name: Getting Run Output
        run: |
          echo "Suite Run ID: ${{ steps.run-bugbug-tests.outputs.suiteRunId }}"

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        with:
          name: bugbug-test-results-${{ matrix.suite }}
          path: test-results-${{ github.run_id }}.xml

      - name: Display Test Summary
        run: |
          echo "### 📝 Test Summary" >> $GITHUB_STEP_SUMMARY
      
          # Extract total test details from ONLY <testsuites>
          TOTAL_TESTS=$(grep -oP '<testsuites[^>]+tests="\K[0-9]+' test-results-${{ github.run_id }}.xml | awk '{s+=$1} END {print s}')
          FAILED_TESTS=$(grep -oP '<testsuites[^>]+failures="\K[0-9]+' test-results-${{ github.run_id }}.xml | awk '{s+=$1} END {print s}')
          ERRORS=$(grep -oP '<testsuites[^>]+errors="\K[0-9]+' test-results-${{ github.run_id }}.xml | awk '{s+=$1} END {print s}')
          SKIPPED_TESTS=$(grep -oP '<testsuites[^>]+skipped="\K[0-9]+' test-results-${{ github.run_id }}.xml | awk '{s+=$1} END {print s}')
      
          # Display overall summary
          echo "| Metric        | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ✅ Total Tests  | $TOTAL_TESTS |" >> $GITHUB_STEP_SUMMARY
          echo "| ❌ Failed Tests | $FAILED_TESTS |" >> $GITHUB_STEP_SUMMARY
          echo "| ⚠️ Errors       | $ERRORS |" >> $GITHUB_STEP_SUMMARY
          echo "| ⏭️ Skipped      | $SKIPPED_TESTS |" >> $GITHUB_STEP_SUMMARY
      
          # Extract and list individual test cases with execution time
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 🏆 Individual Test Cases" >> $GITHUB_STEP_SUMMARY
          echo "| Test Case | Execution Time (ms) |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------------------|" >> $GITHUB_STEP_SUMMARY
      
          grep -oP '<testcase name="[^"]+" classname="[^"]+" time="[^"]+"' test-results-${{ github.run_id }}.xml | while read -r line; do
            TEST_NAME=$(echo "$line" | grep -oP '(?<=classname=")[^"]+')
            EXECUTION_TIME=$(echo "$line" | grep -oP '(?<=time=")[^"]+')
            echo "| $TEST_NAME | $EXECUTION_TIME |" >> $GITHUB_STEP_SUMMARY
          done
      
          # Highlight test results
          if [ "$FAILED_TESTS" -gt 0 ] || [ "$ERRORS" -gt 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "⚠️ **Some tests failed!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "🎉 **All tests passed!**" >> $GITHUB_STEP_SUMMARY
          fi

